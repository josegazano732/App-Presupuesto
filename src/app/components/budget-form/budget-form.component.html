<div class="container mb-5">
  <div id="budget-content" class="content-wrapper">
    <app-client-info [client]="budget.client"></app-client-info>

    <!-- Labor Costos -->
    <h4>Nota de Pedido</h4>

    <!-- Mobile Vista -->
    <div class="mobile-view">
      <div *ngFor="let item of budget.laborCosts; let i = index" class="budget-item-card">
        <div class="form-group">
          <label>Producto</label>
          <div class="position-relative">
            <input type="text" maxlength="30" class="form-control" [(ngModel)]="item.descripcion" placeholder="Ingrese un producto" required (input)="filtrarProductosPorIndice(i, item.descripcion)">
            <ul *ngIf="productoFiltradoIndex === i && productoFiltrado.length > 0" class="list-group position-absolute w-100" style="z-index: 10;">
              <li *ngFor="let prod of productoFiltrado" class="list-group-item list-group-item-action" (click)="seleccionarProducto(item, prod)">
                {{ prod }}
              </li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <label>Cantidad</label>
          <input type="number" min="1" max="999" class="form-control" [(ngModel)]="item.cantidad" required (ngModelChange)="updateLaborCostCantidad(i, item.cantidad)">
        </div>
        <div class="form-group">
          <label>Unidad de Medida</label>
          <select class="form-control" [(ngModel)]="item.unidadMedida" required>
            <option value="" disabled selected>Seleccione</option>
            <option *ngFor="let unidad of unidadesMedida" [value]="unidad">{{unidad}}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Precio Unitario</label>
          <input type="number" min="0" step="0.01" class="form-control" [(ngModel)]="item.precioUnitario" required (ngModelChange)="updateLaborCostPrecioUnitario(i, item.precioUnitario)">
        </div>
        <div class="form-group">
          <label>Total</label>
          <input type="number" class="form-control" [value]="item.cantidad * item.precioUnitario" readonly>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <button class="btn btn-danger" (click)="removeLaborCost(i)">
            <i class="bi bi-trash"></i> Eliminar
          </button>
        </div>
      </div>
      <button class="btn btn-primary mb-4" (click)="addLaborCost()" [disabled]="!isLaborCostValid()">
        <i class="bi bi-plus"></i> Agregar Línea
      </button>
    </div>

    <!-- Desktop Vista -->
    <div class="desktop-view table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>PRODUCTO</th>
            <th>CANTIDAD</th>
            <th>UNIDAD DE MEDIDA</th>
            <th>PRECIO UNITARIO</th>
            <th>TOTAL</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of budget.laborCosts; let i = index">
            <td>
              <div class="position-relative">
                <input type="text" maxlength="30" class="form-control" [(ngModel)]="item.descripcion" placeholder="Ingrese un producto" required (input)="filtrarProductosPorIndice(i, item.descripcion)">
                <ul *ngIf="productoFiltradoIndex === i && productoFiltrado.length > 0" class="list-group position-absolute w-100" style="z-index: 10;">
                  <li *ngFor="let prod of productoFiltrado" class="list-group-item list-group-item-action" (click)="seleccionarProducto(item, prod)">
                    {{ prod }}
                  </li>
                </ul>
              </div>
              <div *ngIf="!item.descripcion" class="text-danger" style="font-size: 0.875em; margin-top: 0.5em; color: #dc3545; font-weight: bold; background-color: #f8d7da; padding: 0.5em; border-radius: 0.25em;">
                La descripción no puede estar vacía.
              </div>
            </td>
            <td>
              <input type="number" min="1" max="999" class="form-control" [(ngModel)]="item.cantidad" required (ngModelChange)="updateLaborCostCantidad(i, item.cantidad)">
            </td>
            <td>
              <select class="form-control" [(ngModel)]="item.unidadMedida" required>
                <option value="" disabled selected>Seleccione</option>
                <option *ngFor="let unidad of unidadesMedida" [value]="unidad">{{unidad}}</option>
              </select>
            </td>
            <td>
              <input type="number" min="0" step="0.01" class="form-control" [(ngModel)]="item.precioUnitario" required (ngModelChange)="updateLaborCostPrecioUnitario(i, item.precioUnitario)">
            </td>
            <td>
              <input type="number" class="form-control" [value]="item.cantidad * item.precioUnitario" readonly>
            </td>
            <td>
              <button class="btn btn-danger btn-sm" (click)="removeLaborCost(i)">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="text-end">Total:</td>
            <td colspan="2">{{ formatCurrency(budget.totalLaborCost) }}</td>
          </tr>
        </tfoot>
      </table>
      <button class="btn btn-primary mb-4" (click)="addLaborCost()" [disabled]="!isLaborCostValid()">
        <i class="bi bi-plus"></i> Agregar Línea
      </button>
    </div>

    <!-- Observations -->
    <div class="mb-5 " >
      <h5>OBSERVACIONES</h5>
      <textarea 
        class="form-control" 
        rows="4" 
        [(ngModel)]="budget.observations"
        placeholder="Ingrese observaciones adicionales...">
      </textarea>
    </div>

    <!-- Totals Summary -->
    <div class="totals-summary ">
      <div class="totals-grid container"> 
        <div class="total-item">
          <h6>Total General</h6>
          <p class="h6">{{formatCurrency(totalLaborLines)}}</p>
        </div>
        <div class="total-item">
            <button class="btn btn-primary m-1" (click)="downloadPDF()" [disabled]="!isFormComplete()">
            <i class="bi bi-download">Descargar</i> PDF
            </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Action Buttons 
  <div class="action-buttons">
    <button class="btn btn-primary" (click)="downloadPDF()">
      <i class="bi bi-download"></i> PDF
    </button>
  </div>-->
</div>